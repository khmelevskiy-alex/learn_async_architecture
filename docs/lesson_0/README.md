# Проектирование сервиса

## Содержание
1. [Описание дизайна взаимодействия сервисов](#design)
    1. [Сервис аутентификации (Auth service)](#design_auth)
    1. [Сервис задач (Task tracker)](#design_task_tracker)
    1. [Сервис бухгалтерии (Accounting)](#design_accounting)
    1. [Сервис аналитики (Analytics)](#design_analytics)
1. [Проблемы и пути их решения](#troubles_transport)
    1. [Недоступность базы данных](#troubles_database)
    1. [Недоступность сети/очереди](#troubles_transport)
    1. [Получение событий в порядке их возникновения](#troubles_ordering)

---

### Описание дизайна взаимодействия сервисов <a name="design"></a>

![Черновик проекта будущего сервиса](./async_architecture_lesson_0.jpg)

#### Сервис аутентификации (Auth service) <a name="design_auth"></a>
* Хранение информации о зарегистрированных пользователях (фио, роль).
* Предоставление API для аутентификации в других сервисах.
* Отправка асинхронных событий:
    * Регистрация (создание) пользователя.
    * Изменении данных пользователя.

#### Сервис задач (Task tracker) <a name="design_task_tracker"></a>
* Хранение информации о задачах (описание, статус, исполнитель)
* Слушание асинхронных событий:
    * Регистрация (создание) пользователя.
    * Изменении данных пользователя (роль).
* Отправка асинхронных событий:
    * Созадние задачи (уже с исполнителем).
    * Переназначение исполнителя.
    * Выполнение задачи (перевод статуса).

#### Сервис бухгалтерии (Accounting) <a name="design_accounting"></a>
* Хранение информации:
    * Стоимость задачи (задача, сумма списания при назначении задачи, сумма начисления при выполнении задачи).
    * Начислениях/списаниях по задачам (исполнитель, задача, сумма, операция выплаты).
    * Выплаты исполнителю (исполнитель, дата/время, сумма).
    * Баланс исполнителя (исполнитель, дата, баланс).
* Слушание асинхронных событий:
    * Регистрация (создание) пользователя.
* Отправка асинхронных событий:
    * Выполнение задачи (с суммами начисления/списания).
    * Выплата исполнителю.
    * Изменение баланса исполнителя.

#### Сервис аналитики (Analytics) <a name="design_analytics"></a>
* Хранение информации:
    * Выплаты за день.
    * Отицательный баланс исполнителя.
    * Стоимость выполненных задач (задача, суммы, дата).
* Слушание асинхронных событий:
    * Регистрация (создание) пользователя.
    * Выполнение задачи (с суммами начисления/списания).
    * Выплата исполнителю.
    * Изменение баланса исполнителя.


### Проблемы и пути их решения <a name="troubles"></a>

#### Недоступность базы данных <a name="troubles_database"></a>
* На стороне источника события
    * Событие не может быть создано, если не произведена запись в БД.
* На стороне слушателя события
    * Событие не может быть вычитано (ack) из очереди, если при обработке этого события возникает ошибка.

#### Недоступность сети/очереди <a name="troubles_transport"></a>
* На стороне источника события
    * Генерируемые события складываются в локальную БД, уже из которой идет отправка. В случае недоступности сети/очереди, будут накапливаться события, которые будут отправлены при восстановлении.
* На стороне слушателя события
    * Дополнительной обработки не требуется.

#### Гарантия получения событий в порядке их возникновения <a name="troubles_ordering"></a>
* Вот здесь пока однозначного решения нет. Вроде как kafka умеет гарантировать очередность событий, но это не точно.
